---
header-includes: 
  - \thispagestyle{empty}
  - \usepackage{setspace}
  - \setstretch{2}
  - \AtBeginEnvironment{tabular}{\doublespacing}
  - \AtBeginEnvironment{lltable}{\doublespacing}
  - \AtBeginEnvironment{tablenotes}{\doublespacing}
  - \captionsetup[table]{font={stretch=1.5}}
  - \captionsetup[figure]{font={stretch=1.5}}
  - \usepackage{booktabs}

title             : "CSL3D"
shorttitle        : "CSL3D"

author: 
  - name          : "Dion T. Henare"
    affiliation   : "1"
    corresponding : yes
    address       : "Gutenbergstraße 18, 35032 Marburg"
    email         : "dion.henare@uni-marburg.de"
  - name          : "Hanna Kadel"
    affiliation   : "1"
  - name          : "Anna Schuboe"
    affiliation   : "1"

affiliation:
  - id            : "1"
    institution   : "Philipps-University of Marburg, Germany"

author_note: |
  Funded by the Deutsche Forschungsgemeinschaft (DFG, German Research Foundation) – project number 222641018 – SFB/TRR 135 TP B3

abstract: |
  Abstract goes here

bibliography      : ["CSL3D_references.bib"]

figsintext        : yes
figurelist        : no
tablelist         : no
footnotelist      : no
lineno            : no
mask              : no

numbersection     : no
class             : "man"
output            : papaja::apa6_pdf

---

\raggedbottom

```{r setup, include = FALSE}
set.seed(4609948)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
library(knitr)
opts_chunk$set(echo = FALSE)
library("papaja")
library(dplyr)
library(tidyr)
library(ggplot2)
```

```{r organiseBehavData}
#Load day 1 data
day1Behav <- read.table("Behaviour/CSL3D_Behav_Day1.csv",header = TRUE, sep=",")
#Remove eprme junk
day1Behav <- select(day1Behav, -c(Session,DataFile.Basename,AutoResponseWarning,Clock.Information,Display.RefreshRate,ExperimentVersion,RandomSeed,RuntimeCapabilities,RuntimeVersion,RuntimeVersionExpected,SessionDate,SessionStartDateTimeUtc,SessionTime,StudioVersion,TestMode,BlockAccC,BlockAccL,BlockRTC,BlockRTL,pos1,pos2,pos3,pos4,pos5,pos6,pos7,pos8,posColor,posShape,posSingDistr,posTarget,PracticeL,PracticeL.Cycle,PracticeL.Sample,PracticeLC,PracticeLC.Cycle,PracticeLC.Sample,CompSearch.OnsetToOnsetTime,LearnSearch.OnsetToOnsetTime,Response.OnsetToOnsetTime, Response2.OnsetToOnsetTime, Task, Task.Cycle, Task.Sample)
)
#Add session information and a count variable
day1Behav$Session = 1
day1Behav$Count = 1

#Load day 2 data
day2Behav <- read.table("Behaviour/CSL3D_Behav_Day2.csv",header = TRUE, sep=",")
#Remove eprme junk
day2Behav <- select(day2Behav, -c(Session,DataFile.Basename,AutoResponseWarning,Clock.Information,Display.RefreshRate,ExperimentVersion,RandomSeed,RuntimeCapabilities,RuntimeVersion,RuntimeVersionExpected,SessionDate,SessionStartDateTimeUtc,SessionTime,StudioVersion,TestMode,BlockAccC,BlockAccL,BlockRTC,BlockRTL,pos1,pos2,pos3,pos4,pos5,pos6,pos7,pos8,posColor,posShape,posSingDistr,posTarget,PracticeL,PracticeL.Cycle,PracticeL.Sample,CompSearch.OnsetToOnsetTime,LearnSearch.OnsetToOnsetTime,Response.OnsetToOnsetTime, Response2.OnsetToOnsetTime,LC4Blocks, LC4Blocks.Cycle, LC4Blocks.Sample)
)
#Add session information and a count variable
day2Behav$Session = 2
day2Behav$Count = 1

day3Behav <- read.table("Behaviour/CSL3D_Behav_Day3.csv",header = TRUE, sep=",")
#Remove eprme junk
day3Behav <- select(day3Behav, -c(Session,DataFile.Basename,AutoResponseWarning,Clock.Information,Display.RefreshRate,ExperimentVersion,RandomSeed,RuntimeCapabilities,RuntimeVersion,RuntimeVersionExpected,SessionDate,SessionStartDateTimeUtc,SessionTime,StudioVersion,TestMode,BlockAccC,BlockAccL,BlockRTC,BlockRTL,pos1,pos2,pos3,pos4,pos5,pos6,pos7,pos8,posColor,posShape,posSingDistr,posTarget, Task, Task.Cycle, Task.Sample)
)
#Add session information and a count variable
day3Behav$Session = 3
day3Behav$Count = 1

#Bind the 3 sessions together and remove old data
behavData <- rbind(day1Behav, day2Behav, day3Behav)
rm(day1Behav, day2Behav, day3Behav)

#Remove test data subjects
behavData <- filter(behavData, Subject != 99 & Subject != 999)

#Add group assignment information to data
groupData <- read.table("Behaviour/CSL3D_GroupInfo.csv",header = TRUE, sep=",")
for (Subj in c(1:36)) {
    behavData$Group[behavData$Subject==Subj] = groupData$Group[groupData$Subject==Subj]
}
behavData$Group <- as.factor(behavData$Group)
levels(behavData$Group) <- c("CC","CS","SC","SS")
```

```{r summaryTables, include=FALSE}
behavData %>% 
  group_by(Subject, Session) %>%
  summarise(numTrials = sum(Count)) %>%
  spread(Session, numTrials)

behavData %>%
  group_by(Subject, Group) %>%
  summarise(numTrials = sum(Count))
```

```{r behavPlots}
behavData %>%
  filter(Procedure == "TaskL", Session != 2, LearnSearch.ACC==1) %>%
  mutate(Session = as.factor(Session)) %>%
  group_by(Group, Session) %>%
  summarise(ResponseTime = mean(LearnSearch.RT)) %>%
  ggplot(., aes(Session, ResponseTime, fill=Group)) +
  geom_bar(stat = "identity") +
  facet_grid(.~Group) +
  theme_apa()

behavData %>%
  filter(Procedure == "TaskC", Session != 2, CompSearch.ACC==1) %>%
  mutate(Session = as.factor(Session), CompCond = ifelse(LateralityComp=="TC" | LateralityComp=="TL","TO", "TD")) %>%
  group_by(Group, Session, CompCond) %>%
  summarise(ResponseTime = mean(CompSearch.RT)) %>%
  ggplot(., aes(x = Session, y = ResponseTime, group = CompCond, fill=CompCond)) +
  geom_bar(position = "dodge", stat = "identity") +
  facet_grid(.~Group) +
  theme_apa()

behavData %>%
  filter(Procedure == "TaskC", Session != 2, CompSearch.ACC==1) %>%
  mutate(Session = as.factor(Session), CompCond = ifelse(LateralityComp=="TC" | LateralityComp=="TL","TO", "TD")) %>%
  group_by(Group, Session, CompCond) %>%
  summarise(ResponseTime = mean(CompSearch.RT)) %>%
  spread(CompCond, ResponseTime) %>%
  mutate(DistractorInterference = TD - TO) %>%
  ggplot(., aes(Session, DistractorInterference, fill=Group)) +
  geom_bar(stat = "identity") +
  facet_grid(.~Group) +
  theme_apa()

behavData %>%
  mutate(CompCond = ifelse(LateralityComp=="TC" | LateralityComp=="TL","TO", "TD")) %>%
  filter(Procedure == "TaskC",  CompCond == "TD", CompSearch.RT<1000) %>%
  mutate(Session = as.factor(Session)) %>%
  group_by(Group, Session, Block) %>%
  summarise(ResponseTime = mean(CompSearch.RT)) %>%
  ggplot(., aes(Block, ResponseTime, group = Group, fill=Group)) +
  #geom_point(aes(colour = Group)) +
  geom_smooth(aes(colour = Group), method = "lm") +
  #scale_y_continuous(limits = c(0,2000)) +
  facet_grid(.~Session, scales = "free") +
  theme_apa()

behavData %>%
  filter(Procedure == "TaskL", Session != 2, LearnSearch.ACC == 1) %>%
  mutate(Session = as.factor(Session)) %>%
  group_by(Group, Session, Block) %>%
  summarise(ResponseTime = mean(LearnSearch.RT)) %>%
  ggplot(., aes(Block, ResponseTime, group = Group, fill=Group)) +
  geom_point(aes(colour = Group)) +
  facet_grid(Group~Session) +
  geom_smooth() +
  scale_y_continuous(limits = c(0,2000)) +
  theme_apa()
```

```{r organiseData}
dPath = 'EEG/Day1/'
fPrefix = 'N2pc'

#####
#Creates aggregate of all participant data (needs dPath and fPrefix)
eFilePattern = paste(fPrefix,"*_epochs.csv", sep="")
lFilePattern = paste(fPrefix,"*_LH.csv", sep="")
rFilePattern = paste(fPrefix,"*_RH.csv", sep="")
eFileList = list.files(dPath, pattern=glob2rx(eFilePattern))
lFileList = list.files(dPath, pattern=glob2rx(lFilePattern))
rFileList = list.files(dPath, pattern=glob2rx(rFilePattern))

#create variables using first dataset
epochInfo = read.csv(file = paste(dPath,eFileList[1], sep=""))
epochInfo$Subject = 1
lHemData = read.csv(file = paste(dPath,lFileList[1], sep=""), header = FALSE)
rHemData = read.csv(file = paste(dPath,rFileList[1], sep=""), header = FALSE)
#append the other datasets to the above variables
for (subj in 2:length(eFileList)) {
  curEpochInfo = read.csv(file = paste(dPath,eFileList[subj], sep=""))
  curEpochInfo$Subject = subj
  curLHemData = read.csv(file = paste(dPath,lFileList[subj], sep=""), header = FALSE)
  curRHemData = read.csv(file = paste(dPath,rFileList[subj], sep=""), header = FALSE)
  
  epochInfo = rbind(epochInfo, curEpochInfo)
  lHemData = rbind(lHemData, curLHemData)
  rHemData = rbind(rHemData, curRHemData)
}

#clear stuff that I don't need
rm(curEpochInfo,curLHemData,curRHemData, fPrefix, eFileList, eFilePattern, lFileList, lFilePattern, rFileList, rFilePattern, subj)
####
#Permutation can be done at this stage using epochInfo$Hemifield = sample(epochInfo$Hemifield, replace=FALSE)
#combine all the data together into one long table
gathercols = colnames(lHemData)
lHemData$Hem = "Left"
rHemData$Hem = "Right"
scalpData = rbind(lHemData,rHemData)
origEpochInfo = rbind(epochInfo,epochInfo)

allData <- cbind(origEpochInfo, scalpData)
allData <- gather(allData, "sample", "voltage", gathercols, factor_key = TRUE)

#Tidy variable names etc. and create any necessary variables - could use unite
allData$sample <- as.integer(substring(allData$sample,2))
allData <- allData %>% mutate(Hemisphere = ifelse(Hemifield==Hem, "Ipsilateral", "Contralateral"))
allData$Session <- 1

#clear stuff that I don't need
rm(origEpochInfo,scalpData)

dPath = 'EEG/Day3/'
fPrefix = 'N2pc'

#####
#Creates aggregate of all participant data (needs dPath and fPrefix)
eFilePattern = paste(fPrefix,"*_epochs.csv", sep="")
lFilePattern = paste(fPrefix,"*_LH.csv", sep="")
rFilePattern = paste(fPrefix,"*_RH.csv", sep="")
eFileList = list.files(dPath, pattern=glob2rx(eFilePattern))
lFileList = list.files(dPath, pattern=glob2rx(lFilePattern))
rFileList = list.files(dPath, pattern=glob2rx(rFilePattern))

#create variables using first dataset
epochInfo = read.csv(file = paste(dPath,eFileList[1], sep=""))
epochInfo$Subject = 1
lHemData = read.csv(file = paste(dPath,lFileList[1], sep=""), header = FALSE)
rHemData = read.csv(file = paste(dPath,rFileList[1], sep=""), header = FALSE)
#append the other datasets to the above variables
for (subj in 2:length(eFileList)) {
  curEpochInfo = read.csv(file = paste(dPath,eFileList[subj], sep=""))
  curEpochInfo$Subject = subj
  curLHemData = read.csv(file = paste(dPath,lFileList[subj], sep=""), header = FALSE)
  curRHemData = read.csv(file = paste(dPath,rFileList[subj], sep=""), header = FALSE)
  
  epochInfo = rbind(epochInfo, curEpochInfo)
  lHemData = rbind(lHemData, curLHemData)
  rHemData = rbind(rHemData, curRHemData)
}

#clear stuff that I don't need
rm(curEpochInfo,curLHemData,curRHemData, fPrefix, eFileList, eFilePattern, lFileList, lFilePattern, rFileList, rFilePattern, subj)
####
#Permutation can be done at this stage using epochInfo$Hemifield = sample(epochInfo$Hemifield, replace=FALSE)
#combine all the data together into one long table
gathercols = colnames(lHemData)
lHemData$Hem = "Left"
rHemData$Hem = "Right"
scalpData = rbind(lHemData,rHemData)
origEpochInfo = rbind(epochInfo,epochInfo)

day3Data <- cbind(origEpochInfo, scalpData)
day3Data <- gather(day3Data, "sample", "voltage", gathercols, factor_key = TRUE)

#Tidy variable names etc. and create any necessary variables - could use unite
day3Data$sample <- as.integer(substring(day3Data$sample,2))
day3Data <- day3Data %>% mutate(Hemisphere = ifelse(Hemifield==Hem, "Ipsilateral", "Contralateral"))
day3Data$Session <- 3

#clear stuff that I don't need
rm(origEpochInfo,scalpData)

allData <- rbind(allData, day3Data)

rm(day3Data, epochInfo, lHemData, rHemData)

groupData <- read.table("Behaviour/CSL3D_GroupInfo.csv",header = TRUE, sep=",")
for (Subj in c(1:39)) {
    allData$Group[allData$Subject==Subj] = groupData$Group[groupData$Subject==Subj]
}
allData$Group <- as.factor(allData$Group)
levels(allData$Group) <- c("CC","CS","SC","SS")

allData <-  mutate(allData, Group1 = substr(allData$Group,1,1))
allData <-  mutate(allData, Group2 = substr(allData$Group,2,2))
allData <-  mutate(allData, GroupP = ifelse(Group1 == Group2, "Stay", "Switch"))
allData <-  mutate(allData, Contra = ifelse(Hemifield == Hem, "Ipsilateral", "Contralateral"))
```

```{r setParams}
baseline = 200
plotWidth = 24
plotHeight = 9

NtStart = 185
NtEnd = 250
PdStart = 250
PdEnd = 350
```

```{r}

allData %>%
  filter(Event == "Learn", Session == 1, LatStim != "None") %>%
  mutate(sample = sample*2-baseline) %>%
  group_by(LatStim,sample,Contra,Group1) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_line(aes(colour = Group1),size=0.5) +
    scale_colour_brewer(palette = "Set1") +
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(LatStim~.) +
    geom_vline(xintercept = 0,linetype = "dashed" ) +
    geom_hline(yintercept = 0,linetype = "dashed") +
    theme_apa() +
    theme(panel.spacing.y = unit(2, "lines"), text= element_text(size=12))

allData %>%
  filter(Event == "Learn", Session == 3, LatStim != "None") %>%
  mutate(sample = sample*2-baseline) %>%
  group_by(LatStim,sample,Contra,Group2) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_line(aes(colour = Group2),size=0.5) +
    scale_colour_brewer(palette = "Set1") +
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(LatStim~.) +
    geom_vline(xintercept = 0,linetype = "dashed" ) +
    geom_hline(yintercept = 0,linetype = "dashed") +
    theme_apa() +
    theme(panel.spacing.y = unit(2, "lines"), text= element_text(size=12))

allData %>%
  filter(Event == "Learn", Session == 1, LatStim != "None") %>%
  mutate(sample = sample*2-baseline) %>%
  group_by(LatStim,sample,Contra,GroupP) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_line(aes(colour = GroupP),size=0.5) +
    scale_colour_brewer(palette = "Set1") +
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(LatStim~.) +
    geom_vline(xintercept = 0,linetype = "dashed" ) +
    geom_hline(yintercept = 0,linetype = "dashed") +
    theme_apa() +
    theme(panel.spacing.y = unit(2, "lines"), text= element_text(size=12))

allData %>%
  filter(Event == "Learn", Session == 3, LatStim != "None") %>%
  mutate(sample = sample*2-baseline) %>%
  group_by(LatStim,sample,Contra,GroupP) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_line(aes(colour = GroupP),size=0.5) +
    scale_colour_brewer(palette = "Set1") +
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(LatStim~.) +
    geom_vline(xintercept = 0,linetype = "dashed" ) +
    geom_hline(yintercept = 0,linetype = "dashed") +
    theme_apa() +
    theme(panel.spacing.y = unit(2, "lines"), text= element_text(size=12))
```


```{r}

allData %>%
  filter(Event == "Search", Session == 1, LatStim != "None") %>%
  mutate(sample = sample*2-baseline) %>%
  group_by(LatStim,sample,Contra,Group1) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_line(aes(colour = Group1),size=0.5) +
    scale_colour_brewer(palette = "Set1") +
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(LatStim~.) +
    geom_vline(xintercept = 0,linetype = "dashed" ) +
    geom_hline(yintercept = 0,linetype = "dashed") +
    theme_apa() +
    theme(panel.spacing.y = unit(2, "lines"), text= element_text(size=12))

allData %>%
  filter(Event == "Search", Session == 3, LatStim != "None") %>%
  mutate(sample = sample*2-baseline) %>%
  group_by(LatStim,sample,Contra,Group2) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_line(aes(colour = Group2),size=0.5) +
    scale_colour_brewer(palette = "Set1") +
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(LatStim~.) +
    geom_vline(xintercept = 0,linetype = "dashed" ) +
    geom_hline(yintercept = 0,linetype = "dashed") +
    theme_apa() +
    theme(panel.spacing.y = unit(2, "lines"), text= element_text(size=12))

allData %>%
  filter(Event == "Search", Session == 1, LatStim != "None") %>%
  mutate(sample = sample*2-baseline) %>%
  group_by(LatStim,sample,Contra,GroupP) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_line(aes(colour = GroupP),size=0.5) +
    scale_colour_brewer(palette = "Set1") +
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(LatStim~.) +
    geom_vline(xintercept = 0,linetype = "dashed" ) +
    geom_hline(yintercept = 0,linetype = "dashed") +
    theme_apa() +
    theme(panel.spacing.y = unit(2, "lines"), text= element_text(size=12))

allData %>%
  filter(Event == "Search", Session == 3, LatStim != "None") %>%
  mutate(sample = sample*2-baseline) %>%
  group_by(LatStim,sample,Contra,GroupP) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral) %>%
  ggplot(., aes(sample,diff)) +
    geom_line(aes(colour = GroupP),size=0.5) +
    scale_colour_brewer(palette = "Set1") +
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(LatStim~.) +
    geom_vline(xintercept = 0,linetype = "dashed" ) +
    geom_hline(yintercept = 0,linetype = "dashed") +
    theme_apa() +
    theme(panel.spacing.y = unit(2, "lines"), text= element_text(size=12))
```

\newpage

# References
```{r create_r-references}
r_refs(file = "CSL3D_references.bib")
```

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id = "refs"></div>
\endgroup

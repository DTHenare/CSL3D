---
title: "CSL_Producedata"
output: html_document
---


```{r setup, include = FALSE}
set.seed(4609948)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed)
library(knitr)
opts_chunk$set(echo = FALSE)
library("papaja")
library(dplyr)
library(tidyr)
library(ggplot2)
library(xtable)
library(afex)
library(emmeans)
```

# Behavioural data
```{r organiseBehavData}
#Load day 1 data
day1Behav <- read.table("Behaviour/CSL3D_Behav_Day1.csv",header = TRUE, sep=",")
#Remove eprme junk
day1Behav <- select(day1Behav, -c(Session,DataFile.Basename,AutoResponseWarning,Clock.Information,Display.RefreshRate,ExperimentVersion,RandomSeed,RuntimeCapabilities,RuntimeVersion,RuntimeVersionExpected,SessionDate,SessionStartDateTimeUtc,SessionTime,StudioVersion,TestMode,BlockAccC,BlockAccL,BlockRTC,BlockRTL,pos1,pos2,pos3,pos4,pos5,pos6,pos7,pos8,posColor,posShape,posSingDistr,posTarget,PracticeL,PracticeL.Cycle,PracticeL.Sample,PracticeLC,PracticeLC.Cycle,PracticeLC.Sample,CompSearch.OnsetToOnsetTime,LearnSearch.OnsetToOnsetTime,Response.OnsetToOnsetTime, Response2.OnsetToOnsetTime, Task, Task.Cycle, Task.Sample)
)
#Add session information and a count variable
day1Behav$Session = 1
day1Behav$Count = 1

#Load day 2 data
day2Behav <- read.table("Behaviour/CSL3D_Behav_Day2.csv",header = TRUE, sep=",")
#Remove eprme junk
day2Behav <- select(day2Behav, -c(Session,DataFile.Basename,AutoResponseWarning,Clock.Information,Display.RefreshRate,ExperimentVersion,RandomSeed,RuntimeCapabilities,RuntimeVersion,RuntimeVersionExpected,SessionDate,SessionStartDateTimeUtc,SessionTime,StudioVersion,TestMode,BlockAccC,BlockAccL,BlockRTC,BlockRTL,pos1,pos2,pos3,pos4,pos5,pos6,pos7,pos8,posColor,posShape,posSingDistr,posTarget,PracticeL,PracticeL.Cycle,PracticeL.Sample,CompSearch.OnsetToOnsetTime,LearnSearch.OnsetToOnsetTime,Response.OnsetToOnsetTime, Response2.OnsetToOnsetTime,LC4Blocks, LC4Blocks.Cycle, LC4Blocks.Sample)
)
#Add session information and a count variable
day2Behav$Session = 2
day2Behav$Count = 1

day3Behav <- read.table("Behaviour/CSL3D_Behav_Day3.csv",header = TRUE, sep=",")
#Remove eprme junk
day3Behav <- select(day3Behav, -c(Session,DataFile.Basename,AutoResponseWarning,Clock.Information,Display.RefreshRate,ExperimentVersion,RandomSeed,RuntimeCapabilities,RuntimeVersion,RuntimeVersionExpected,SessionDate,SessionStartDateTimeUtc,SessionTime,StudioVersion,TestMode,BlockAccC,BlockAccL,BlockRTC,BlockRTL,pos1,pos2,pos3,pos4,pos5,pos6,pos7,pos8,posColor,posShape,posSingDistr,posTarget, Task, Task.Cycle, Task.Sample)
)
#Add session information and a count variable
day3Behav$Session = 3
day3Behav$Count = 1

#Bind the 3 sessions together and remove old data
behavData <- rbind(day1Behav, day2Behav, day3Behav)
rm(day1Behav, day2Behav, day3Behav)

#Remove test data subjects
behavData <- behavData %>% mutate(Subject = ifelse(Subject==99,37,Subject))
behavData <- behavData %>% mutate(Subject = ifelse(Subject==999,37,Subject))
#behavData <- filter(behavData, Subject != 99 & Subject != 999)

#Add group assignment information to data
groupData <- read.table("Behaviour/CSL3D_GroupInfo.csv",header = TRUE, sep=",")
for (Subj in c(1:37)) {
    behavData$Group[behavData$Subject==Subj] = groupData$Group[groupData$Subject==Subj]
}
behavData$Group = factor(behavData$Group, labels = c("Colour-Colour", "Colour-Shape", "Shape-Colour","Shape-Shape"))
#behavData$Group = factor(behavData$Group, levels = c("Colour-Colour", "Colour-Shape", "Shape-Shape", "Shape-Colour"))
behavData <- behavData %>% filter(ExperimentName != "CSL 3D Tag1 Å¡bung")
behavData <- behavData %>% mutate(CompSearch.RT = ifelse(is.na(CompSearch.RT), 2000,CompSearch.RT))
behavData <- behavData %>% separate(Group, c("InitSess", "FinSess"), remove = FALSE) %>%
mutate(Session = as.factor(Session), retrain = ifelse(InitSess == FinSess, "Stay", "Switch"), CompCond = ifelse(LateralityComp=="TC" | LateralityComp=="TL","TO", "TD"), InitSess = as.factor(InitSess), FinSess = as.factor(FinSess))
```

```{r summaryTables, include=FALSE}
behavData %>% 
  group_by(Subject, Session) %>%
  summarise(numTrials = sum(Count)) %>%
  spread(Session, numTrials)

behavData %>%
  group_by(Subject, Group) %>%
  summarise(numTrials = sum(Count))
```

```{r createExclusionCriteria}
for (sub in unique(behavData$Subject)) {
  behavData$compSD[behavData$Subject==sub] = sd(filter(behavData,Subject ==sub, Procedure == "TaskC", CompSearch.RT < 2000)$CompSearch.RT)
  behavData$compMean[behavData$Subject==sub] = mean(filter(behavData,Subject ==sub, Procedure == "TaskC", CompSearch.RT < 2000)$CompSearch.RT)
  behavData$learnSD[behavData$Subject==sub] = sd(filter(behavData,Subject ==sub, Procedure == "TaskL", LearnSearch.RT <2000)$LearnSearch.RT)
  behavData$learnMean[behavData$Subject==sub] = mean(filter(behavData,Subject ==sub, Procedure == "TaskL", LearnSearch.RT <2000)$LearnSearch.RT)
}
behavData$compCutoff <- behavData$compMean + (behavData$compSD * 2.5)
behavData$learnCutoff <- behavData$learnMean + (behavData$learnSD * 2.5)

#documenting trial rejection
alltrials <- behavData %>%
  group_by(Subject,Group, Procedure) %>%
  count()
survabrej <- behavData %>%
  filter(LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff) %>%
  group_by(Subject, Group, Procedure) %>%
  count()
survallrej <- behavData %>%
  filter(LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff,LearnSearch.ACC==1 | CompSearch.ACC==1) %>%
  group_by(Subject, Group, Procedure) %>%
  count()
alltrials = cbind(alltrials,two = survabrej$n,three = survallrej$n)
alltrials %>%
  mutate(twoPerc = (n-two)/n*100, threePerc = (two - three)/n*100) %>%
  group_by(Procedure) %>%
  summarise(twomean = mean(twoPerc), threemean = mean(threePerc))
```

## Initial Training

```{r behavInitTraining}
cat.acc.init <- behavData %>%
  filter(Procedure == "TaskL", Session == 1, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff) %>%
  group_by(InitSess,Subject) %>%
  summarise(Accuracy = mean(LearnSearch.ACC))
cat.acc.init.aov <- aov_ez(data = cat.acc.init,
                            dv = "Accuracy",
                            id = "Subject",
                            between = c("InitSess")
                            )
cat.acc.init.t <- t.test()
cat.rt.init <- behavData %>%
  filter(Procedure == "TaskL", Session == 1, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, LearnSearch.ACC == 1) %>%
  group_by(InitSess,Subject) %>%
  summarise(ResponseTime = mean(LearnSearch.RT))
cat.rt.init.aov <- aov_ez(data = cat.rt.init,
                          dv = "ResponseTime",
                          id = "Subject",
                          between = c("InitSess")
                          )
srch.acc.init <- behavData %>%
  filter(Procedure == "TaskC", Session == 1, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff) %>%
  group_by(InitSess,CompCond,Subject) %>%
  summarise(Accuracy = mean(CompSearch.ACC))
srch.acc.init.aov <- aov_ez(data = srch.acc.init,
                            dv = "Accuracy",
                            id = "Subject",
                            within = c("CompCond"),
                            between = c("InitSess")
                            )
srch.rt.init <- behavData %>%
  filter(Procedure == "TaskC", Session == 1, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, CompSearch.ACC == 1) %>%
  group_by(InitSess,CompCond,Subject) %>%
  summarise(ResponseTime = mean(CompSearch.RT))
srch.rt.init.aov <- aov_ez(data = srch.rt.init,
                           dv = "ResponseTime",
                           id = "Subject",
                           within = c("CompCond"),
                           between = c("InitSess")
                           )
distint.init <- behavData %>%
  filter(Procedure == "TaskC", Session == 1, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, CompSearch.ACC == 1) %>%
  group_by(InitSess,CompCond,Subject) %>%
  summarise(ResponseTime = mean(CompSearch.RT)) %>%
  spread(CompCond, ResponseTime) %>%
  mutate(DistractorInterference = TD - TO)
distint.init.aov <- aov_ez(data = distint.init,
                           dv = "DistractorInterference",
                           id = "Subject",
                           between = c("InitSess")
                           )
```

## Extended Training Effects

```{r behavExtdTraining}
cat.acc.extd <- behavData %>%
  filter(Procedure == "TaskL", Session != 2, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, InitSess == FinSess) %>%
  group_by(InitSess,Session, Subject) %>%
  summarise(Accuracy = mean(LearnSearch.ACC))
cat.acc.extd.aov <- aov_ez(data = cat.acc.extd,
                            dv = "Accuracy",
                            id = "Subject",
                            within = c("Session"),
                            between = c("InitSess")
                            )
cat.rt.extd <- behavData %>%
  filter(Procedure == "TaskL", Session != 2, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, InitSess == FinSess, LearnSearch.ACC == 1) %>%
  group_by(InitSess,Session,Subject) %>%
  summarise(ResponseTime = mean(LearnSearch.RT))
cat.rt.extd.aov <- aov_ez(data = cat.rt.extd,
                          dv = "ResponseTime",
                          id = "Subject",
                          within = c("Session"),
                          between = c("InitSess")
                          )
srch.acc.extd <- behavData %>%
  filter(Procedure == "TaskC", Session != 2, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, InitSess == FinSess) %>%
  group_by(InitSess,Session,CompCond,Subject) %>%
  summarise(Accuracy = mean(CompSearch.ACC))
srch.acc.extd.aov <- aov_ez(data = srch.acc.extd,
                            dv = "Accuracy",
                            id = "Subject",
                            within = c("Session","CompCond"),
                            between = c("InitSess")
                            )
srch.rt.extd <- behavData %>%
  filter(Procedure == "TaskC", Session != 2, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, InitSess == FinSess, CompSearch.ACC == 1) %>%
  group_by(InitSess,Session,CompCond,Subject) %>%
  summarise(ResponseTime = mean(CompSearch.RT))
srch.rt.extd.aov <- aov_ez(data = srch.rt.extd,
                           dv = "ResponseTime",
                           id = "Subject",
                           within = c("Session","CompCond"),
                           between = c("InitSess")
                           )

distint.extd <- behavData %>%
  filter(Procedure == "TaskC", Session != 2, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, InitSess == FinSess, CompSearch.ACC == 1) %>%
  group_by(InitSess,Session,CompCond,Subject) %>%
  summarise(ResponseTime = mean(CompSearch.RT)) %>%
  spread(CompCond, ResponseTime) %>%
  mutate(DistractorInterference = TD - TO)
distint.extd.aov <- aov_ez(data = distint.extd,
                           dv = "DistractorInterference",
                           id = "Subject",
                           within = c("Session"),
                           between = c("InitSess")
                           )
distint.extd.emmeans <- emmeans(distint.extd.aov, ~InitSess*Session)
distint.extd.posthoc <- pairs(distint.extd.emmeans)
```

## Retraining Effects
```{r behavRetrTraining}
cat.acc.retr <- behavData %>%
  filter(Procedure == "TaskL", Session == 3, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff) %>%
  group_by(retrain,FinSess, Subject) %>%
  summarise(Accuracy = mean(LearnSearch.ACC))
cat.acc.retr.aov <- aov_ez(data = cat.acc.retr,
                            dv = "Accuracy",
                            id = "Subject",
                            between = c("retrain","FinSess")
                            )
cat.rt.retr <- behavData %>%
  filter(Procedure == "TaskL", Session == 3, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, LearnSearch.ACC == 1) %>%
  group_by(retrain,FinSess,Subject) %>%
  summarise(ResponseTime = mean(LearnSearch.RT))
cat.rt.retr.aov <- aov_ez(data = cat.rt.retr,
                          dv = "ResponseTime",
                          id = "Subject",
                          between = c("retrain","FinSess")
                          )
srch.acc.retr <- behavData %>%
  filter(Procedure == "TaskC", Session == 3, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff) %>%
  group_by(retrain,FinSess,CompCond,Subject) %>%
  summarise(Accuracy = mean(CompSearch.ACC))
srch.acc.retr.aov <- aov_ez(data = srch.acc.retr,
                            dv = "Accuracy",
                            id = "Subject",
                            within = c("CompCond"),
                            between = c("retrain","FinSess")
                            )
srch.rt.retr <- behavData %>%
  filter(Procedure == "TaskC", Session == 3, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, CompSearch.ACC == 1) %>%
  group_by(FinSess,retrain,CompCond,Subject) %>%
  summarise(ResponseTime = mean(CompSearch.RT))
srch.rt.retr.aov <- aov_ez(data = srch.rt.retr,
                           dv = "ResponseTime",
                           id = "Subject",
                           within = c("CompCond"),
                           between = c("retrain","FinSess")
                           )
distint.retr <- behavData %>%
  filter(Procedure == "TaskC", Session == 3, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff, CompSearch.ACC == 1) %>%
  group_by(FinSess,retrain,CompCond,Subject) %>%
  summarise(ResponseTime = mean(CompSearch.RT)) %>%
  spread(CompCond, ResponseTime) %>%
  mutate(DistractorInterference = TD - TO)
distint.retr.aov <- aov_ez(data = distint.retr,
                           dv = "DistractorInterference",
                           id = "Subject",
                           between = c("retrain","FinSess")
                           )
```

```{r saveBehavData}
save(cat.acc.init.aov, cat.rt.init.aov, srch.acc.init.aov, srch.rt.init.aov,distint.init.aov, cat.acc.extd.aov, cat.rt.extd.aov, srch.acc.extd.aov, srch.rt.extd.aov, distint.extd.aov, distint.extd.posthoc, cat.acc.retr.aov, cat.rt.retr.aov, srch.acc.retr.aov, srch.rt.retr.aov, distint.retr.aov, file = "DataOutput/behavANOVAs.RData")
```

```{r behavPlots}
behavData %>%
  filter(Procedure == "TaskL", Session != 2, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff) %>%
  mutate(Session = as.factor(Session)) %>%
  group_by(Group, Session,Subject) %>%
  summarise(Accuracy = mean(LearnSearch.ACC)) %>%
  mutate(se = sd(Accuracy)/sqrt(9))%>%
  group_by(Group,Session)%>%
  summarise(Accuracy = mean(Accuracy)*100, se = mean(se)*100) %>%
  ggplot(., aes(Session, Accuracy)) +
  geom_bar(stat = "identity") +
  facet_grid(.~Group) +
  geom_errorbar(aes(ymin = Accuracy-se, ymax = Accuracy+se), width = .2) +
  coord_cartesian(ylim=c(75,100))+
  theme_apa()
ggsave("Figures/Behav1.tiff", dpi = 600, width = 16, height = 8, units = "cm")

behavData %>%
  filter(Procedure == "TaskL", Session != 2, LearnSearch.ACC==1, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff) %>%
  mutate(Session = as.factor(Session)) %>%
  group_by(Group, Session,Subject) %>%
  summarise(ResponseTime = mean(LearnSearch.RT)) %>%
  mutate(se = sd(ResponseTime)/sqrt(9))%>%
  group_by(Group,Session)%>%
  summarise(ResponseTime = mean(ResponseTime), se = mean(se)) %>%
  ggplot(., aes(Session, ResponseTime)) +
  geom_bar(stat = "identity") +
  facet_grid(.~Group) +
  geom_errorbar(aes(ymin = ResponseTime-se, ymax = ResponseTime+se), width = .2) +
  coord_cartesian(ylim=c(400,800))+
  theme_apa()
ggsave('Figures/Behav2.tiff', dpi = 600, width = 16, height = 8, units = "cm")

behavData %>%
  filter(Procedure == "TaskC", Session != 2, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff) %>%
  mutate(Session = as.factor(Session), CompCond = ifelse(LateralityComp=="TC" | LateralityComp=="TL","TO", "TD")) %>%
  group_by(Group, Session, CompCond,Subject) %>%
  summarise(Accuracy = mean(CompSearch.ACC)) %>%
  mutate(se = sd(Accuracy)/sqrt(9))%>%
  group_by(Group,Session,CompCond)%>%
  summarise(Accuracy = mean(Accuracy)*100, se = mean(se)*100) %>%
  ggplot(., aes(x = Session, y = Accuracy, group = CompCond, fill=CompCond)) +
  geom_bar(position = "dodge", stat = "identity") +
  facet_grid(.~Group) +
  geom_errorbar(aes(ymin = Accuracy-se, ymax = Accuracy+se), width = .2, position=position_dodge(.9)) +
  coord_cartesian(ylim=c(75,100))+
  theme_apa()
ggsave('Figures/Behav3.tiff', dpi = 600, width = 16, height = 8, units = "cm")

behavData %>%
  filter(Procedure == "TaskC", Session != 2, CompSearch.ACC==1, LearnSearch.RT < learnCutoff | CompSearch.RT < compCutoff) %>%
  mutate(Session = as.factor(Session), CompCond = ifelse(LateralityComp=="TC" | LateralityComp=="TL","TO", "TD")) %>%
  group_by(Group, Session, CompCond,Subject) %>%
  summarise(ResponseTime = mean(CompSearch.RT)) %>%
  mutate(se = sd(ResponseTime)/sqrt(9))%>%
  group_by(Group,Session,CompCond)%>%
  summarise(ResponseTime = mean(ResponseTime), se = mean(se)) %>%
  ggplot(., aes(x = Session, y = ResponseTime, group = CompCond, fill=CompCond)) +
  geom_bar(position = "dodge", stat = "identity") +
  facet_grid(.~Group) +
  geom_errorbar(aes(ymin = ResponseTime-se, ymax = ResponseTime+se), width = .2, position = position_dodge(.9)) +
  scale_fill_manual(values=c("red4", "gray42"))+
  coord_cartesian(ylim=c(500,800))+
  theme_apa() +
  theme(#legend.position = "None",
        axis.line = element_line(colour = "black"))
ggsave('Figures/Behav4.tiff', dpi = 600, width = 16, height = 8, units = "cm")

behavData %>%
  filter(Procedure == "TaskC", Session != 2, CompSearch.ACC==1) %>%
  mutate(Session = as.factor(Session), CompCond = ifelse(LateralityComp=="TC" | LateralityComp=="TL","TO", "TD")) %>%
  group_by(Group, Session, CompCond, Subject) %>%
  summarise(ResponseTime = mean(CompSearch.RT)) %>%
  spread(CompCond, ResponseTime) %>%
  mutate(DistractorInterference = TD - TO) %>%
  mutate(se = sd(DistractorInterference)/9) %>%
  group_by(Group, Session) %>%
  summarise(DistractorInterference = mean(DistractorInterference), se = mean(se)) %>%
  ggplot(., aes(Session, DistractorInterference)) +
  geom_bar(stat = "identity", fill = "turquoise4") +
  facet_grid(.~Group) +
  geom_errorbar(aes(ymin = DistractorInterference-se, ymax = DistractorInterference+se), width = .2) +
  theme_apa() +
  theme(text= element_blank(),
          strip.text.y = element_blank(),
          strip.text.x = element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),
          legend.position = "None")
```

```{r clearBehavData, include=FALSE}
rm(list = ls())
gc()
```

# EEG data
```{r organiseData}
dPath = 'EEG/Visuals/'
fPrefix = 'N2pc'

#Load group data
groupdata = read.csv(file="Behaviour/CSL3D_GroupInfo.csv")

#####
#Creates aggregate of all participant data (needs dPath and fPrefix)
eFilePattern = paste(fPrefix,"*_epochs.csv", sep="")
lFilePattern = paste(fPrefix,"*_LH.csv", sep="")
rFilePattern = paste(fPrefix,"*_RH.csv", sep="")
eFileList = list.files(dPath, pattern=glob2rx(eFilePattern))
lFileList = list.files(dPath, pattern=glob2rx(lFilePattern))
rFileList = list.files(dPath, pattern=glob2rx(rFilePattern))

#create variables using first dataset
epochInfo = read.csv(file = paste(dPath,eFileList[1], sep=""))
epochInfo$Subject = 1
epochInfo$Group = groupdata$Group[1]
lHemData = read.csv(file = paste(dPath,lFileList[1], sep=""), header = FALSE)
rHemData = read.csv(file = paste(dPath,rFileList[1], sep=""), header = FALSE)
#append the other datasets to the above variables
for (subj in 2:length(eFileList)) {
  curEpochInfo = read.csv(file = paste(dPath,eFileList[subj], sep=""))
  curEpochInfo$Subject = subj
  curEpochInfo$Group = groupdata$Group[subj]
  curLHemData = read.csv(file = paste(dPath,lFileList[subj], sep=""), header = FALSE)
  curRHemData = read.csv(file = paste(dPath,rFileList[subj], sep=""), header = FALSE)
  
  epochInfo = rbind(epochInfo, curEpochInfo)
  lHemData = rbind(lHemData, curLHemData)
  rHemData = rbind(rHemData, curRHemData)
}
#Tidy the variables, remove unnecessary and convert to factors
epochInfo$Subject = as.factor(epochInfo$Subject)

#clear stuff that I don't need
rm(curEpochInfo,curLHemData,curRHemData, fPrefix, eFileList, eFilePattern, lFileList, lFilePattern, rFileList, rFilePattern, subj, groupdata)
gc()
#####
#Permutation can be done at this stage using epochInfo$Hemifield = sample(epochInfo$Hemifield, replace=FALSE)
#combine all the data together into one long table
gathercols = colnames(lHemData)
lHemData$Hem = "Left"
rHemData$Hem = "Right"
scalpData = rbind(lHemData,rHemData)
origEpochInfo = rbind(epochInfo,epochInfo)

allData <- cbind(origEpochInfo, scalpData)
allData <- gather(allData, "sample", "voltage", gathercols, factor_key = TRUE)

#Tidy variable names etc. and create any necessary variables - could use unite
allData$sample <- as.integer(substring(allData$sample,2))
allData <- allData %>% mutate(Contra = ifelse(Hemifield==Hem, "Ipsilateral", "Contralateral"))
allData <- allData %>% mutate(Stimulus = as.factor(paste(LatStim," (",MidStim," mid)", sep = "")))

#clear stuff that I don't need
rm(origEpochInfo,scalpData,epochInfo, lHemData, rHemData)
gc()
#Change factor labels
allData <-  mutate(allData, Group1 = substr(allData$Group,1,1))
allData <-  mutate(allData, Group2 = substr(allData$Group,2,2))
allData <-  mutate(allData, GroupP = ifelse(Group1 == Group2, "Unchanged", "Changed"))
allData <-  mutate(allData, Contra = ifelse(Hemifield == Hem, "Ipsilateral", "Contralateral"))

allData$Group = factor(allData$Group, labels = c("Colour-Colour", "Colour-Shape", "Shape-Colour", "Shape-Shape"))
allData$Group = factor(allData$Group, levels = c("Colour-Colour", "Shape-Colour", "Shape-Shape", "Colour-Shape"))
allData$Stimulus = factor(allData$Stimulus, levels = c("Color (Shape mid)", "Shape (Color mid)", "Target (None mid)", "Target (Distractor mid)", "Distractor (Target mid)","None (Target mid)"))
allData$Group  <- as.factor(allData$Group)
allData$Group1 <- as.factor(allData$Group1)
allData$Group2 <- as.factor(allData$Group2)
allData$GroupP <- as.factor(allData$GroupP)
gc()
```

```{r setParams}
baseline = 200
srateMultiplier = 1
winSize = 100
winBnd <- 0.8
fixedWin=1

learnRej <- allData %>%
  filter(Event == "Learn", sample == 1, Contra == "Contralateral") %>%
  group_by(Subject) %>%
  summarise(Trials = sum(sample)) %>%
  mutate(learnReject = ifelse(Trials < 400,1,0))
searchRej <- allData %>%
  filter(Event == "Search", sample == 1, Contra == "Contralateral") %>%
  group_by(Subject) %>%
  summarise(Trials = sum(sample)) %>%
  mutate(searchReject = ifelse(Trials < 500,1,0))
#mutate(allData, learnRej = NaN, searchRej = NaN)
for (i in unique(allData$Subject)) {
  allData$learnRej[allData$Subject == i] = learnRej$learnReject[learnRej$Subject==i]
  allData$searchRej[allData$Subject == i] = searchRej$searchReject[searchRej$Subject==i]
}
```

```{r trialCount}
print(
  xtable(allData %>%
    filter(Event == "Learn",sample == 1, Contra == 'Contralateral') %>%
    group_by(Subject,LatStim) %>%
    summarise(trialCount = sum(sample), rej = mean(learnRej)) %>%
      spread(LatStim,trialCount)
  ,digits = 0)
,include.rownames = FALSE, comment = FALSE)

print(
  xtable(allData %>%
    filter(Event == "Search",sample == 1, Contra == 'Contralateral') %>%
    group_by(Subject,LatStim,Group) %>%
    summarise(trialCount = sum(sample), rej = mean(learnRej)) %>%
      spread(LatStim,trialCount)
  ,digits = 0)
,include.rownames = FALSE, comment = FALSE)
```

## Learn Task

### Initial Training

#### Target Lateralised

```{r lernInitTarg}
grandTarget <- allData %>%
  filter(Session == "Day1", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 150 & sample < 300) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ColNTStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  ColNTEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
  peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
  peakValue <- min(grandTarget$diff)
  ColNTStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
  postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
  ColNTEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
learn.Init.Col <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day1", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0 & sample>ColNTStart & sample < ColNTEnd) %>%
  group_by(Group1,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Init.ColNt.aov <- aov_ez(
  data = learn.Init.Col,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = "Group1"
)
learn.Init.ColNt.results <- apa_print(learn.Init.ColNt.aov)
learn.Init.ColNt.fup <- apa_print.emmGrid(pairs(emmeans(learn.Init.ColNt.aov, ~Contra|Group1)))

grandTarget <- allData %>%
  filter(Session == "Day1", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 150 & sample < 300) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ShpNTStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  ShpNTEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
peakValue <- min(grandTarget$diff)
ShpNTStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
ShpNTStart = ifelse(is.na(ShpNTStart),200,ShpNTStart)
postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
ShpNTEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
learn.Init.Shp <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day1", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0 & sample>ShpNTStart & sample < ShpNTEnd) %>%
  group_by(Group1,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Init.ShpNt.aov <- aov_ez(
  data = learn.Init.Shp,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = "Group1"
)
learn.Init.ShpNt.results <- apa_print(learn.Init.ShpNt.aov)
learn.Init.ShpNt.fup <- apa_print.emmGrid(pairs(emmeans(learn.Init.ShpNt.aov, ~Contra|Group1)))
```

#### Distractor Lateralised
```{r lernInitDist}
grandDist <- allData %>%
  filter(Session == "Day1", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ColPdStart = grandDist$sample[grandDist$diff == max(grandDist$diff)]-winSize/2
  ColPdEnd = grandDist$sample[grandDist$diff == max(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- min(grandDist$diff)
ColPdStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff>peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
ColPdEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
learn.Init.ColPd <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day1", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0 & sample>ColPdStart & sample < ColPdEnd) %>%
  group_by(Group1,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Init.ColPd.aov <- aov_ez(
  data = learn.Init.ColPd,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = "Group1"
)
learn.Init.ColPd.results <- apa_print(learn.Init.ColPd.aov)
learn.Init.ColPd.fup <- apa_print.emmGrid(pairs(emmeans(learn.Init.ColPd.aov, ~Contra|Group1)))
grandDist <- allData %>%
  filter(Session == "Day1", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ShpPdStart = grandDist$sample[grandDist$diff == max(grandDist$diff)]-winSize/2
  ShpPdEnd = grandDist$sample[grandDist$diff == max(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- max(grandDist$diff)
ShpPdStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff<peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
ShpPdEnd <- postPeakData$sample[min(which(postPeakData$diff < peakValue*winBnd))]
}
learn.Init.ShpPd <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day1", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0 & sample>ShpPdStart & sample < ShpPdEnd) %>%
  group_by(Group1,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Init.ShpPd.aov <- aov_ez(
  data = learn.Init.ShpPd,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = "Group1"
)
learn.Init.ShpPd.results <- apa_print(learn.Init.ShpPd.aov)
learn.Init.ShpPd.fup <- apa_print.emmGrid(pairs(emmeans(learn.Init.ShpPd.aov, ~Contra|Group1)))
```

```{r savelernInitERPData}
save(learn.Init.ColNt.results, learn.Init.ShpNt.results, learn.Init.ColPd.results, learn.Init.ShpPd.results, learn.Init.ColNt.fup, learn.Init.ShpNt.fup, learn.Init.ColPd.fup, learn.Init.ShpPd.fup, file = "DataOutput/lernInitERPANOVAs.RData")
```

```{r lernInitERPPlot}
    allData %>%
        filter(Session == "Day1", Event == "Learn"  & learnRej == 0) %>%
        mutate(sample = sample-baseline) %>%
        group_by(Stimulus,sample,Contra,Group1) %>%
        summarise(mean = mean(voltage)) %>%
        spread(Contra, mean) %>% 
        mutate(diff = Contralateral - Ipsilateral) %>%
        ggplot(., aes(sample,diff)) +
        geom_rect(data = . %>% filter(Stimulus  == "Color (Shape mid)"),xmin = ColNTStart, xmax = ColNTEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
        geom_rect(data = . %>% filter(Stimulus  == "Shape (Color mid)"),xmin = ShpNTStart, xmax = ShpNTEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
        geom_rect(data = . %>% filter(Stimulus  == "Color (Shape mid)"),xmin = ColPdStart, xmax = ColPdEnd, ymin = -Inf, ymax = 0, fill = "lemonchiffon") +
        geom_rect(data = . %>% filter(Stimulus  == "Shape (Color mid)"),xmin = ShpPdStart, xmax = ShpPdEnd, ymin = -Inf, ymax = 0, fill = "lemonchiffon") +
        geom_vline(xintercept = 0,aes(colour= "gray") ) +
        geom_hline(yintercept = 0,aes(colour= "gray") ) +
        geom_line( aes(colour = Group1),size=1) +
        scale_color_manual(values=c("seagreen3", "gray52"))+
        scale_x_continuous(name ="Latency (ms)", expand = c(0, 0), limits=c(-200, 500), breaks=seq(-200,500,200)) +
        scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
        facet_grid(.~Stimulus, labeller = labeller(Stimulus = c("Color (Shape mid)" = "Target Only", "Shape (Color mid)" = "Target","Distractor (Target mid)" = "Distractor"))) +
        theme_apa() +
      theme(text = element_text(size=10))
ggsave("Figures/lernInitERPs.tiff", dpi = 600, width = 16, height = 8, units = "cm")
```

### Extended training effects

#### Target Lateralised

```{r lernExtdTarg}
grandTarget <- allData %>%
  filter(GroupP == "Unchanged", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 150 & sample < 300) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ColNTStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  ColNTEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
peakValue <- min(grandTarget$diff)
ColNTStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
ColNTEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
learn.Extd.Col <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(GroupP == "Unchanged", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0 & sample>ColNTStart & sample < ColNTEnd) %>%
  group_by(Group1,Session,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Extd.ColNt.aov <- aov_ez(
  data = learn.Extd.Col,
  dv = "mV",
  id = "Subject",
  within = c("Contra","Session"),
  between = "Group1"
)
learn.Extd.ColNt.results <- apa_print(learn.Extd.ColNt.aov)
learn.Extd.ColNt.fup <- apa_print.emmGrid(pairs(emmeans(learn.Extd.ColNt.aov, ~Contra|Group1*Session)))

grandTarget <- allData %>%
  filter(GroupP == "Unchanged", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 150 & sample < 300) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ShpNTStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  ShpNTEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
peakValue <- min(grandTarget$diff)
ShpNTStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
ShpNTStart = ifelse(is.na(ShpNTStart),200,ShpNTStart)
postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
ShpNTEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
learn.Extd.Shp <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(GroupP == "Unchanged", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0 & sample>ShpNTStart & sample < ShpNTEnd) %>%
  group_by(Group1,Session,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Extd.ShpNt.aov <- aov_ez(
  data = learn.Extd.Shp,
  dv = "mV",
  id = "Subject",
  within = c("Contra","Session"),
  between = "Group1"
)
learn.Extd.ShpNt.results <- apa_print(learn.Extd.ShpNt.aov)
learn.Extd.ShpNt.fup <- apa_print.emmGrid(pairs(emmeans(learn.Extd.ShpNt.aov, ~Contra|Group1*Session)))
```

#### Distractor Lateralised
```{r lernExtdDist}
grandDist <- allData %>%
  filter(GroupP == "Unchanged", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ColPdStart = grandDist$sample[grandDist$diff == max(grandDist$diff)]-winSize/2
  ColPdEnd = grandDist$sample[grandDist$diff == max(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- min(grandDist$diff)
ColPdStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff>peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
ColPdEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
learn.Extd.ColPd <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(GroupP == "Unchanged", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0 & sample>ColPdStart & sample < ColPdEnd) %>%
  group_by(Group1,Session,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Extd.ColPd.aov <- aov_ez(
  data = learn.Extd.ColPd,
  dv = "mV",
  id = "Subject",
  within = c("Contra","Session"),
  between = "Group1"
)
learn.Extd.ColPd.results <- apa_print(learn.Extd.ColPd.aov)
learn.Extd.ColPd.fup <- apa_print.emmGrid(pairs(emmeans(learn.Extd.ColPd.aov, ~Contra|Session*Group1)))
grandDist <- allData %>%
  filter(GroupP == "Unchanged", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ShpPdStart = grandDist$sample[grandDist$diff == max(grandDist$diff)]-winSize/2
  ShpPdEnd = grandDist$sample[grandDist$diff == max(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- max(grandDist$diff)
ShpPdStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff<peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
ShpPdEnd <- postPeakData$sample[min(which(postPeakData$diff < peakValue*winBnd))]
}
learn.Extd.ShpPd <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(GroupP == "Unchanged", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0 & sample>ShpPdStart & sample < ShpPdEnd) %>%
  group_by(Group1,Session,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Extd.ShpPd.aov <- aov_ez(
  data = learn.Extd.ShpPd,
  dv = "mV",
  id = "Subject",
  within = c("Contra","Session"),
  between = "Group1"
)
learn.Extd.ShpPd.results <- apa_print(learn.Extd.ShpPd.aov)
learn.Extd.ShpPd.fup <- apa_print.emmGrid(pairs(emmeans(learn.Extd.ShpPd.aov, ~Contra|Session)))
```

```{r savelernExtdERPData}
save(learn.Extd.ColNt.results, learn.Extd.ShpNt.results, learn.Extd.ColPd.results, learn.Extd.ShpPd.results, learn.Extd.ColNt.fup, learn.Extd.ShpNt.fup, learn.Extd.ColPd.fup, learn.Extd.ShpPd.fup, file = "DataOutput/lernExtdERPANOVAs.RData")
```

```{r lernExtdERPPlot}
allData %>%
    filter(GroupP == "Unchanged", Event == "Learn"  & learnRej == 0 & LatStim != "None") %>%
    mutate(sample = sample-baseline) %>%
    group_by(Stimulus,Session,sample,Contra,Group1) %>%
    summarise(mean = mean(voltage)) %>%
    spread(Contra, mean) %>% 
    mutate(diff = Contralateral - Ipsilateral) %>%
    ggplot(., aes(sample,diff)) +
    geom_rect(data = . %>% filter(Stimulus  == "Color (Shape mid)"),xmin = ColNTStart, xmax = ColNTEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Shape (Color mid)"),xmin = ShpNTStart, xmax = ShpNTEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Color (Shape mid)"),xmin = ColPdStart, xmax = ColPdEnd, ymin = -Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Shape (Color mid)"),xmin = ShpPdStart, xmax = ShpPdEnd, ymin = -Inf, ymax = 0, fill = "lemonchiffon") +
    geom_vline(xintercept = 0,aes(colour= "gray") ) +
    geom_hline(yintercept = 0,aes(colour= "gray") ) +
    geom_line( aes(colour = interaction(Group1,Session)),size=0.8) +
    scale_color_manual(values=c("seagreen3", "red3","seagreen4", "red4"))+
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0), limits=c(-200, 500), breaks=seq(-200,500,200)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(Group1~Stimulus, labeller = labeller(Stimulus = c("Color (Shape mid)" = "Target Only", "Shape (Color mid)" = "Target","Distractor (Target mid)" = "Distractor"))) +
    theme_apa()+
    theme(text = element_text(size=10),
          legend.text = element_text( size = 4),
          legend.title = element_text( size = 4))
ggsave("Figures/lernExtdERPs.tiff", dpi = 600, width = 16, height = 8, units = "cm")
```

### Retraining effects

#### Target Lateralised

```{r lernRetrTarg}
grandTarget <- allData %>%
  filter(Session == "Day3", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 150 & sample < 300) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ColNTStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  ColNTEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
peakValue <- min(grandTarget$diff)
ColNTStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
ColNTEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
learn.Retr.Col <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day3", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0 & sample>ColNTStart & sample < ColNTEnd) %>%
  group_by(Group2,GroupP,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Retr.ColNt.aov <- aov_ez(
  data = learn.Retr.Col,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = c("Group2","GroupP")
)
learn.Retr.ColNt.results <- apa_print(learn.Retr.ColNt.aov)
learn.Retr.ColNt.fup <- apa_print.emmGrid(pairs(emmeans(learn.Retr.ColNt.aov, ~Contra|Group2*GroupP)))
grandTarget <- allData %>%
  filter(Session == "Day3", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 150 & sample < 300) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ShpNTStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  ShpNTEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
peakValue <- min(grandTarget$diff)
ShpNTStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
ShpNTStart = ifelse(is.na(ShpNTStart),200,ShpNTStart)
postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
ShpNTEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
learn.Retr.Shp <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day3", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0 & sample>ShpNTStart & sample < ShpNTEnd) %>%
  group_by(Group2,GroupP,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Retr.ShpNt.aov <- aov_ez(
  data = learn.Retr.Shp,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = c("Group2","GroupP")
)
learn.Retr.ShpNt.results <- apa_print(learn.Retr.ShpNt.aov)
learn.Retr.ShpNt.fup <- apa_print.emmGrid(pairs(emmeans(learn.Retr.ShpNt.aov, ~Contra|Group2*GroupP)))
```

#### Distractor Lateralised
```{r lernRetrDist}
grandDist <- allData %>%
  filter(Session == "Day3", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ColPdStart = grandDist$sample[grandDist$diff == max(grandDist$diff)]-winSize/2
  ColPdEnd = grandDist$sample[grandDist$diff == max(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- min(grandDist$diff)
ColPdStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff>peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
ColPdEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
learn.Retr.ColPd <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day3", Event == "Learn" & Stimulus == "Color (Shape mid)" & learnRej == 0 & sample>ColPdStart & sample < ColPdEnd) %>%
  group_by(Group2,GroupP,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Retr.ColPd.aov <- aov_ez(
  data = learn.Retr.ColPd,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = c("Group2","GroupP")
)
learn.Retr.ColPd.results <- apa_print(learn.Retr.ColPd.aov)
learn.Retr.ColPd.fup <- apa_print.emmGrid(pairs(emmeans(learn.Retr.ColPd.aov, ~Contra|GroupP)))
grandDist <- allData %>%
  filter(Session == "Day3", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  ShpPdStart = grandDist$sample[grandDist$diff == max(grandDist$diff)]-winSize/2
  ShpPdEnd = grandDist$sample[grandDist$diff == max(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- max(grandDist$diff)
ShpPdStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff<peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
ShpPdEnd <- postPeakData$sample[min(which(postPeakData$diff < peakValue*winBnd))]
}
learn.Retr.ShpPd <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day3", Event == "Learn" & Stimulus == "Shape (Color mid)" & learnRej == 0 & sample > ShpPdStart & sample < ShpPdEnd) %>%
  group_by(Group2,GroupP,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
learn.Retr.ShpPd.aov <- aov_ez(
  data = learn.Retr.ShpPd,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = c("Group2","GroupP")
)
learn.Retr.ShpPd.results <- apa_print(learn.Retr.ShpPd.aov)
learn.Retr.ShpPd.fup <- apa_print.emmGrid(pairs(emmeans(learn.Retr.ShpPd.aov, ~Contra|GroupP)))
```

```{r savelernRetrERPData}
save(learn.Retr.ColNt.results, learn.Retr.ShpNt.results, learn.Retr.ColPd.results, learn.Retr.ShpPd.results, learn.Retr.ColNt.fup, learn.Retr.ShpNt.fup, learn.Retr.ColPd.fup, learn.Retr.ShpPd.fup,  file = "DataOutput/lernRetrERPANOVAs.RData")
```

```{r lernRetrERPPlot}
allData %>%
    filter(Session == "Day3", Event == "Learn"  & learnRej == 0) %>%
    mutate(sample = sample-baseline) %>%
    group_by(Stimulus,sample,Contra,Group2,GroupP) %>%
    summarise(mean = mean(voltage)) %>%
    spread(Contra, mean) %>% 
    mutate(diff = Contralateral - Ipsilateral) %>%
    ggplot(., aes(sample,diff)) +
    geom_rect(data = . %>% filter(Stimulus  == "Color (Shape mid)"),xmin = ColNTStart, xmax = ColNTEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Shape (Color mid)"),xmin = ShpNTStart, xmax = ShpNTEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Color (Shape mid)"),xmin = ColPdStart, xmax = ColPdEnd, ymin = -Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Shape (Color mid)"),xmin = ShpPdStart, xmax = ShpPdEnd, ymin = -Inf, ymax = 0, fill = "lemonchiffon") +
    geom_vline(xintercept = 0,aes(colour= "gray") ) +
    geom_hline(yintercept = 0,aes(colour= "gray") ) +
    geom_line( aes(colour = interaction(Group2,GroupP)),size=0.8) +
    scale_color_manual(values=c("orange4", "blue4","seagreen4", "red4"))+
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0), limits=c(-200, 500), breaks=seq(-200,500,200)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(Group2~Stimulus, labeller = labeller(Stimulus = c("Color (Shape mid)" = "Target Only", "Shape (Color mid)" = "Target","Distractor (Target mid)" = "Distractor"))) +
    theme_apa()+
    theme(legend.text = element_text( size = 4),
          legend.title = element_text( size = 4),
          text = element_text(size=6))
ggsave("Figures/lernRetrERPs.tiff", dpi = 600, width = 16, height = 8, units = "cm")
```

## Search Task

### Initial Training

#### Target Lateralised

```{r srchInitTarg}
grandTarget <- allData %>%
  filter(Session == "Day1", Event == "Search" & Stimulus == "Target (None mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  TONtStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  TONtEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
  peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
  peakValue <- min(grandTarget$diff)
  TONtStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
  postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
  TONtEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
search.Init.TO <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day1", Event == "Search" & Stimulus == "Target (None mid)" & searchRej == 0 & sample>TONtStart & sample < TONtEnd) %>%
  group_by(Group1,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Init.TO.aov <- aov_ez(
  data = search.Init.TO,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = "Group1"
)
search.Init.TO.results <- apa_print(search.Init.TO.aov)
search.Init.TO.fup <- apa_print.emmGrid(pairs(emmeans(search.Init.TO.aov, ~Contra|Group1)))

grandTarget <- allData %>%
  filter(Session == "Day1", Event == "Search" & Stimulus == "Target (Distractor mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  TDNtStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  TDNtEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
peakValue <- min(grandTarget$diff)
TDNtStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
TDNtStart = ifelse(is.na(TDNtStart),200,TDNtStart)
postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
TDNtEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
search.Init.TD <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day1", Event == "Search" & Stimulus == "Target (Distractor mid)" & searchRej == 0 & sample>TDNtStart & sample < TDNtEnd) %>%
  group_by(Group1,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Init.TD.aov <- aov_ez(
  data = search.Init.TD,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = "Group1"
)
search.Init.TD.results <- apa_print(search.Init.TD.aov)
search.Init.TD.fup <- apa_print.emmGrid(pairs(emmeans(search.Init.TD.aov, ~Contra|Group1)))
```

#### Distractor Lateralised
```{r srchInitDist}
grandDist <- allData %>%
  filter(Session == "Day1", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  DTNtStart = grandDist$sample[grandDist$diff == min(grandDist$diff)]-winSize/2
  DTNtEnd = grandDist$sample[grandDist$diff == min(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- min(grandDist$diff)
DTNtStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff>peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
DTNtEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
search.Init.DTnt <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day1", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0 & sample>DTNtStart & sample < DTNtEnd) %>%
  group_by(Group1,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Init.DTnt.aov <- aov_ez(
  data = search.Init.DTnt,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = "Group1"
)
search.Init.DTnt.results <- apa_print(search.Init.DTnt.aov)
grandDist <- allData %>%
  filter(Session == "Day1", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  DTPdStart = grandDist$sample[grandDist$diff == max(grandDist$diff)]-winSize/2
  DTPdEnd = grandDist$sample[grandDist$diff == max(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- max(grandDist$diff)
DTPdStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff<peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
DTPdEnd <- postPeakData$sample[min(which(postPeakData$diff < peakValue*winBnd))]
}
search.Init.DTpd <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day1", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0 & sample>DTPdStart & sample < DTPdEnd) %>%
  group_by(Group1,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Init.DTpd.aov <- aov_ez(
  data = search.Init.DTpd,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = "Group1"
)
search.Init.DTpd.results <- apa_print(search.Init.DTpd.aov)
search.Init.DTpd.fup <- apa_print.emmGrid(pairs(emmeans(search.Init.DTpd.aov, ~Contra|Group1)))
```

```{r saveSrchInitERPData}
save(search.Init.TO.results, search.Init.TD.results, search.Init.DTnt.results, search.Init.DTpd.results, search.Init.TO.fup, search.Init.TD.fup, search.Init.DTpd.fup, file = "DataOutput/SrchInitERPANOVAs.RData")
```

```{r srchInitERPPlot}
allData %>%
    filter(Session == "Day1", Event == "Search"  & searchRej == 0 & LatStim != "None") %>%
    mutate(sample = sample-baseline) %>%
    group_by(Stimulus,sample,Contra,Group1) %>%
    summarise(mean = mean(voltage)) %>%
    spread(Contra, mean) %>% 
    mutate(diff = Contralateral - Ipsilateral) %>%
    ggplot(., aes(sample,diff)) +
    geom_rect(data = . %>% filter(Stimulus  == "Target (None mid)"),xmin = TONtStart, xmax = TONtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Target (Distractor mid)"),xmin = TDNtStart, xmax = TDNtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Distractor (Target mid)"),xmin = DTNtStart, xmax = DTNtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Distractor (Target mid)"),xmin = DTPdStart, xmax = DTPdEnd, ymin = -Inf, ymax = 0, fill = "lemonchiffon") +
    geom_vline(xintercept = 0,aes(colour= "gray") ) +
    geom_hline(yintercept = 0,aes(colour= "gray") ) +
    #geom_line( aes(colour = interaction(Group,Session)),size=3) +
    geom_line( aes(colour = Group1),size=1) +
    #geom_line(data = . %>% filter(Session == "Day3"), aes(colour = Group),linetype="dashed",size=3) +
    scale_color_manual(values=c("seagreen3", "gray52"))+
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0), limits=c(-200, 500), breaks=seq(-200,500,200)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(.~Stimulus, labeller = labeller(Stimulus = c("Target (None mid)" = "Target Only", "Target (Distractor mid)" = "Target","Distractor (Target mid)" = "Distractor"))) +
    theme_apa() +
  theme(text = element_text(size=10))
ggsave("Figures/SrchInitERPs.tiff", dpi = 600, width = 16, height = 8, units = "cm")
```

### Extended training effects

#### Target Lateralised

```{r srchExtdTarg}
grandTarget <- allData %>%
  filter(GroupP == "Unchanged", Event == "Search" & Stimulus == "Target (None mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  TONtStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  TONtEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
peakValue <- min(grandTarget$diff)
TONtStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
TONtEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
search.Extd.TO <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(GroupP == "Unchanged", Event == "Search" & Stimulus == "Target (None mid)" & searchRej == 0 & sample>TONtStart & sample < TONtEnd) %>%
  group_by(Group1,Session,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Extd.TO.aov <- aov_ez(
  data = search.Extd.TO,
  dv = "mV",
  id = "Subject",
  within = c("Contra","Session"),
  between = "Group1"
)
search.Extd.TO.results <- apa_print(search.Extd.TO.aov)
search.Extd.TO.fup <- apa_print.emmGrid(pairs(emmeans(search.Extd.TO.aov, ~Contra|Group1)))

grandTarget <- allData %>%
  filter(GroupP == "Unchanged", Event == "Search" & Stimulus == "Target (Distractor mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  TDNtStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  TDNtEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
peakValue <- min(grandTarget$diff)
TDNtStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
TDNtStart = ifelse(is.na(TDNtStart),200,TDNtStart)
postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
TDNtEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
search.Extd.TD <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(GroupP == "Unchanged", Event == "Search" & Stimulus == "Target (Distractor mid)" & searchRej == 0 & sample>TDNtStart & sample < TDNtEnd) %>%
  group_by(Group1,Session,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Extd.TD.aov <- aov_ez(
  data = search.Extd.TD,
  dv = "mV",
  id = "Subject",
  within = c("Contra","Session"),
  between = "Group1"
)
search.Extd.TD.results <- apa_print(search.Extd.TD.aov)
search.Extd.TD.fup <- apa_print.emmGrid(pairs(emmeans(search.Extd.TD.aov, ~Contra|Group1)))
```

#### Distractor Lateralised
```{r srchExtdDist}
grandDist <- allData %>%
  filter(GroupP == "Unchanged", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  DTNtStart = grandDist$sample[grandDist$diff == min(grandDist$diff)]-winSize/2
  DTNtEnd = grandDist$sample[grandDist$diff == min(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- min(grandDist$diff)
DTNtStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff>peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
DTNtEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
search.Extd.DTnt <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(GroupP == "Unchanged", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0 & sample>DTNtStart & sample < DTNtEnd) %>%
  group_by(Group1,Session,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Extd.DTnt.aov <- aov_ez(
  data = search.Extd.DTnt,
  dv = "mV",
  id = "Subject",
  within = c("Contra","Session"),
  between = "Group1"
)
search.Extd.DTnt.results <- apa_print(search.Extd.DTnt.aov)
search.Extd.DTnt.fup <- apa_print.emmGrid(pairs(emmeans(search.Extd.DTnt.aov, ~Contra|Session*Group1)))
grandDist <- allData %>%
  filter(GroupP == "Unchanged", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  DTPdStart = grandDist$sample[grandDist$diff == max(grandDist$diff)]-winSize/2
  DTPdEnd = grandDist$sample[grandDist$diff == max(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- max(grandDist$diff)
DTPdStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff<peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
DTPdEnd <- postPeakData$sample[min(which(postPeakData$diff < peakValue*winBnd))]
}
search.Extd.DTpd <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(GroupP == "Unchanged", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0 & sample>DTPdStart & sample < DTPdEnd) %>%
  group_by(Group1,Session,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Extd.DTpd.aov <- aov_ez(
  data = search.Extd.DTpd,
  dv = "mV",
  id = "Subject",
  within = c("Contra","Session"),
  between = "Group1"
)
search.Extd.DTpd.results <- apa_print(search.Extd.DTpd.aov)
search.Extd.DTpd.fup <- apa_print.emmGrid(pairs(emmeans(search.Extd.DTpd.aov, ~Contra|Session)))
```

```{r saveSrchExtdERPData}
save(search.Extd.TO.results, search.Extd.TD.results, search.Extd.DTnt.results, search.Extd.DTpd.results, search.Extd.TO.fup, search.Extd.TD.fup, search.Extd.DTnt.fup, search.Extd.DTpd.fup, file = "DataOutput/SrchExtdERPANOVAs.RData")
```

```{r srchExtdERPPlot}
allData %>%
    filter(GroupP == "Unchanged", Event == "Search"  & searchRej == 0 & LatStim != "None") %>%
    mutate(sample = sample-baseline) %>%
    group_by(Stimulus,Session,sample,Contra,Group1) %>%
    summarise(mean = mean(voltage)) %>%
    spread(Contra, mean) %>% 
    mutate(diff = Contralateral - Ipsilateral) %>%
    ggplot(., aes(sample,diff)) +
    geom_rect(data = . %>% filter(Stimulus  == "Target (None mid)"),xmin = TONtStart, xmax = TONtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Target (Distractor mid)"),xmin = TDNtStart, xmax = TDNtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Distractor (Target mid)"),xmin = DTNtStart, xmax = DTNtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Distractor (Target mid)"),xmin = DTPdStart, xmax = DTPdEnd, ymin = -Inf, ymax = 0, fill = "lemonchiffon") +
    geom_vline(xintercept = 0,aes(colour= "gray") ) +
    geom_hline(yintercept = 0,aes(colour= "gray") ) +
    geom_line( aes(colour = interaction(Group1,Session)),size=0.8) +
    #geom_line( aes(colour = Group1),size=1) +
    #geom_line(data = . %>% filter(Session == "Day3"), aes(colour = Group),linetype="dashed",size=3) +
    scale_color_manual(values=c("seagreen3", "red3","seagreen4", "red4"))+
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0), limits=c(-200, 500), breaks=seq(-200,500,200)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(Group1~Stimulus, labeller = labeller(Stimulus = c("Target (None mid)" = "Target Only", "Target (Distractor mid)" = "Target","Distractor (Target mid)" = "Distractor"))) +
    theme_apa()+
    theme(text = element_text(size=10),
          legend.text = element_text( size = 4),
          legend.title = element_text( size = 4))
ggsave("Figures/SrchExtdERPs.tiff", dpi = 600, width = 16, height = 8, units = "cm")
```

```{r srchExtdERPPlotNOSUB}
allData %>%
    filter(GroupP == "Unchanged", Event == "Search"  & searchRej == 0 & LatStim != "None") %>%
    mutate(sample = sample-baseline) %>%
    group_by(Stimulus,Session,sample,Contra,Group1) %>%
    summarise(mean = mean(voltage)) %>%
    ggplot(., aes(sample,mean)) +
    geom_rect(data = . %>% filter(Stimulus  == "Target (None mid)"),xmin = TONtStart, xmax = TONtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Target (Distractor mid)"),xmin = TDNtStart, xmax = TDNtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Distractor (Target mid)"),xmin = DTNtStart, xmax = DTNtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Distractor (Target mid)"),xmin = DTPdStart, xmax = DTPdEnd, ymin = -Inf, ymax = 0, fill = "lemonchiffon") +
    geom_vline(xintercept = 0,aes(colour= "gray") ) +
    geom_hline(yintercept = 0,aes(colour= "gray") ) +
    geom_line( aes(colour = interaction(Group1,Session),linetype = Contra),size=0.5) +
    #geom_line( aes(colour = Group1),size=1) +
    #geom_line(data = . %>% filter(Session == "Day3"), aes(colour = Group),linetype="dashed",size=3) +
    scale_color_manual(values=c("seagreen3", "red3","seagreen4", "red4"))+
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0), limits=c(-200, 500), breaks=seq(-200,500,200)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(Group1~Stimulus, labeller = labeller(Stimulus = c("Target (None mid)" = "Target Only", "Target (Distractor mid)" = "Target","Distractor (Target mid)" = "Distractor"))) +
    theme_apa()+
    theme(text = element_text(size=10),
          legend.text = element_text( size = 4),
          legend.title = element_text( size = 4))
ggsave("Figures/SrchExtdERPsNOSUB.tiff", dpi = 600, width = 16, height = 8, units = "cm")
```

### Retraining effects

#### Target Lateralised

```{r srchRetrTarg}
grandTarget <- allData %>%
  filter(Session == "Day3", Event == "Search" & Stimulus == "Target (None mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  TONtStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  TONtEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
peakValue <- min(grandTarget$diff)
TONtStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
TONtEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
search.Retr.TO <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day3", Event == "Search" & Stimulus == "Target (None mid)" & searchRej == 0 & sample>TONtStart & sample < TONtEnd) %>%
  group_by(Group2,GroupP,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Retr.TO.aov <- aov_ez(
  data = search.Retr.TO,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = c("Group2","GroupP")
)
search.Retr.TO.results <- apa_print(search.Retr.TO.aov)
grandTarget <- allData %>%
  filter(Session == "Day3", Event == "Search" & Stimulus == "Target (Distractor mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  TDNtStart = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]-winSize/2
  TDNtEnd = grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]+winSize/2
} else {
peakTime <- grandTarget$sample[grandTarget$diff == min(grandTarget$diff)]
peakValue <- min(grandTarget$diff)
TDNtStart <- grandTarget$sample[max(which(grandTarget[1:which(grandTarget$sample==peakTime)-1,]$diff>peakValue*winBnd))]
TDNtStart = ifelse(is.na(TDNtStart),200,TDNtStart)
postPeakData <- grandTarget[which(grandTarget$sample==peakTime)+1:nrow(grandTarget),]
TDNtEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
search.Retr.TD <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day3", Event == "Search" & Stimulus == "Target (Distractor mid)" & searchRej == 0 & sample>TDNtStart & sample < TDNtEnd) %>%
  group_by(Group2,GroupP,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Retr.TD.aov <- aov_ez(
  data = search.Retr.TD,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = c("Group2","GroupP")
)
search.Retr.TD.results <- apa_print(search.Retr.TD.aov)
```

#### Distractor Lateralised
```{r srchRetrDist}
grandDist <- allData %>%
  filter(Session == "Day3", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  DTNtStart = grandDist$sample[grandDist$diff == min(grandDist$diff)]-winSize/2
  DTNtEnd = grandDist$sample[grandDist$diff == min(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- min(grandDist$diff)
DTNtStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff>peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
DTNtEnd <- postPeakData$sample[min(which(postPeakData$diff > peakValue*winBnd))]
}
search.Retr.DTnt <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day3", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0 & sample>DTNtStart & sample < DTNtEnd) %>%
  group_by(Group2,GroupP,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Retr.DTnt.aov <- aov_ez(
  data = search.Retr.DTnt,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = c("Group2","GroupP")
)
search.Retr.DTnt.results <- apa_print(search.Retr.DTnt.aov)

grandDist <- allData %>%
  filter(Session == "Day3", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0) %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(sample > 200) %>%
  group_by(sample,Contra) %>%
  summarise(mean = mean(voltage)) %>%
  spread(Contra, mean) %>% 
  mutate(diff = Contralateral - Ipsilateral)
if (fixedWin) {
  DTPdStart = grandDist$sample[grandDist$diff == max(grandDist$diff)]-winSize/2
  DTPdEnd = grandDist$sample[grandDist$diff == max(grandDist$diff)]+winSize/2
} else {
peakTime <- grandDist$sample[grandDist$diff == max(grandDist$diff)]
peakValue <- max(grandDist$diff)
DTPdStart <- grandDist$sample[max(which(grandDist[1:which(grandDist$sample==peakTime)-1,]$diff<peakValue*winBnd))]
postPeakData <- grandDist[which(grandDist$sample==peakTime)+1:nrow(grandDist),]
DTPdEnd <- postPeakData$sample[min(which(postPeakData$diff < peakValue*winBnd))]
}
search.Retr.DTpd <- allData %>%
  mutate(sample = sample*srateMultiplier-baseline) %>%
  filter(Session == "Day3", Event == "Search" & Stimulus == "Distractor (Target mid)" & searchRej == 0 & sample > DTPdStart & sample < DTPdEnd) %>%
  group_by(Group2,GroupP,Subject,Contra) %>%
  summarise(mV = mean(voltage)) 
search.Retr.DTpd.aov <- aov_ez(
  data = search.Retr.DTpd,
  dv = "mV",
  id = "Subject",
  within = c("Contra"),
  between = c("Group2","GroupP")
)
search.Retr.DTpd.results <- apa_print(search.Retr.DTpd.aov)
search.Retr.DTpd.fup <- apa_print.emmGrid(pairs(emmeans(search.Retr.DTpd.aov, ~Contra|GroupP)))
```

```{r saveSrchRetrERPData}
save(search.Retr.TO.results, search.Retr.TD.results, search.Retr.DTnt.results, search.Retr.DTpd.results, file = "DataOutput/SrchRetrERPANOVAs.RData")
```

```{r srchRetrERPPlot}
allData %>%
    filter(Session == "Day3", Event == "Search"  & searchRej == 0 & LatStim != "None") %>%
    mutate(sample = sample-baseline) %>%
    group_by(Stimulus,sample,Contra,Group2,GroupP) %>%
    summarise(mean = mean(voltage)) %>%
    spread(Contra, mean) %>% 
    mutate(diff = Contralateral - Ipsilateral) %>%
    ggplot(., aes(sample,diff)) +
    geom_rect(data = . %>% filter(Stimulus  == "Target (None mid)"),xmin = TONtStart, xmax = TONtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Target (Distractor mid)"),xmin = TDNtStart, xmax = TDNtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Distractor (Target mid)"),xmin = DTNtStart, xmax = DTNtEnd, ymin = Inf, ymax = 0, fill = "lemonchiffon") +
    geom_rect(data = . %>% filter(Stimulus  == "Distractor (Target mid)"),xmin = DTPdStart, xmax = DTPdEnd, ymin = -Inf, ymax = 0, fill = "lemonchiffon") +
    geom_vline(xintercept = 0,aes(colour= "gray") ) +
    geom_hline(yintercept = 0,aes(colour= "gray") ) +
    geom_line( aes(colour = interaction(Group2,GroupP)),size=0.8) +
    #geom_line( aes(colour = Group1),size=1) +
    #geom_line(data = . %>% filter(Session == "Day3"), aes(colour = Group),linetype="dashed",size=3) +
    scale_color_manual(values=c("orange4", "blue4","seagreen4", "red4"))+
    scale_x_continuous(name ="Latency (ms)", expand = c(0, 0), limits=c(-200, 500), breaks=seq(-200,500,200)) +
    scale_y_reverse(name =expression(paste("Amplitude (",mu,"v)")), expand = c(0, 0)) +
    facet_grid(Group2~Stimulus, labeller = labeller(Stimulus = c("Target (None mid)" = "Target Only", "Target (Distractor mid)" = "Target","Distractor (Target mid)" = "Distractor"))) +
    theme_apa()+
    theme(legend.text = element_text( size = 4),
          legend.title = element_text( size = 4),
          text = element_text(size=6))
ggsave("Figures/SrchRetrERPs.tiff", dpi = 600, width = 16, height = 8, units = "cm")
```

